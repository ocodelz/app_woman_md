"use strict";var utils=require("../utils/util.js"),SNprotoBufUtil=require("../utils/SNprotobufUtil"),ParseState={SYN_FE:"SYN_FE",SYN_VR:"SYN_VR",LEN:"LEN",CMDID:"CMDID",NSEQ:"NSEQ",PBODY:"PBODY",CHKSUM:"CHKSUM"},SN_ReceiveProtobufLib={REQ_AUTH:10001,REQ_SENDDATA:10002,REQ_INIT:10003,RESQ_AUTH:20001,RESQ_SENDDATA:20002,RESQ_INIT:20003,ECI_PUSH_DATA:30001,VALID_COMMAND:65535},psta=ParseState.SYN_FE,MAX_REV_LEN=200,cmdparse=new Uint8Array(MAX_REV_LEN),cmdcnt=0,length=0,nSeq=0,cmd=SN_ReceiveProtobufLib.VALID_COMMAND,deviceId="",serviceId="",characteristicId="0000FEC7-0000-1000-8000-00805F9B34FB";function protoBufData(e){var t=e.value;if("534e"==t.substring(0,4)||"534E"==t.substring(0,4)){var r=Array.prototype.slice.call(new Uint8Array(utils.hexToBytes(t))),a={GLU:""};switch(r[5]){case 4:var s=255&r[12],c=255&r[13],i=Math.round((s<<8)+c)/10;return console.log("==========wl-1血糖结果值=========[["+i+"]]"),(a.GLU=i)<1.1?a.GLU="L":33.3<i&&(a.GLU="H"),a;case 10:console.log("----开始测试----");break;case 11:console.log("----关机指令----");break;case 3:console.log("----滴血闪烁----");break;case 7:console.log("同步时间的指令与获取SN号的指令发送后，WL-1仪器返回相同的数据，返回指令码均为07")}return""}}function getHistoryData(){executeCmd(assemblyData("0004","05","0000"))}function clearHistoryData(){var e=assemblyData("0004","08","0000"),t=SNprotoBufUtil.pushDataToMC(new Int8Array(utils.hexToBytes(e)).buffer);executeCmd(utils.ab2hex(t))}function protoBufparseData(e){deviceId=e.deviceId,serviceId=e.serviceId;var t=e.value;if(t instanceof ArrayBuffer)return t=Array.prototype.slice.call(new Uint8Array(t)),new Promise(function(a){t.forEach(function(e){var t,r=parserReceivedBytes(e);null!=r&&(r.reqAuth?executeCmd(r.reqAuth):r.reqInit&&(executeCmd(r.reqInit),setTimeout(function(){setTime()},500)),r.reqSenddata&&(t=protoBufData({value:r.reqSenddata}),a(t)))})})}function parserReceivedBytes(e){switch(psta){case ParseState.SYN_FE:if(254!=e)return null;psta=ParseState.SYN_VR;break;case ParseState.SYN_VR:if(1!=e)return psta=ParseState.SYN_FE,null;psta=ParseState.LEN;break;case ParseState.LEN:if(1==++cmdcnt)length=255&e;else if(2==cmdcnt){if(cmdcnt=0,(length=((255&length)<<8)+(255&e))<8)return psta=ParseState.SYN_FE,null;psta=ParseState.CMDID}break;case ParseState.CMDID:var t;1==++cmdcnt?nSeq=255&e:2==cmdcnt&&(t=((255&nSeq)<<8)+(255&e),nSeq=cmdcnt=0,cmd=t,psta=ParseState.NSEQ);break;case ParseState.NSEQ:1==++cmdcnt?nSeq=255&e:2==cmdcnt&&(nSeq=((255&nSeq)<<8)+(255&e),cmdcnt=cmdcnt=0,psta=ParseState.PBODY);break;case ParseState.PBODY:if(cmdparse[cmdcnt++]=e,cmdcnt!=length-8)break;psta=ParseState.SYN_FE;var r=paserReceiveBodyByProtobuf(cmdparse,cmdcnt);return cmdcnt=0,r}return null}function paserReceiveBodyByProtobuf(e,t){var r={reqAuth:"",reqInit:"",reqSenddata:""};switch(cmd){case SN_ReceiveProtobufLib.REQ_AUTH:var a=SNprotoBufUtil.AuthResponse(nSeq);return r.reqAuth=utils.ab2hex(a),r;case SN_ReceiveProtobufLib.REQ_INIT:var s=e.slice(t-4,t).buffer,a=SNprotoBufUtil.InitResponse(s,nSeq);return r.reqInit=utils.ab2hex(a),r;case SN_ReceiveProtobufLib.REQ_SENDDATA:s=e.slice(0,t).buffer,a=SNprotoBufUtil.sendDataRequest(s);return r.reqSenddata=utils.ab2hex(a),r}}function setTime(){var e=new Date,t=(t=e.getFullYear()).toString().substring(2,4);t=Number(t);var r=e.getMonth()+1,a=e.getDate(),s=e.getHours(),c=e.getMinutes(),i=utils.intToHex(t)+utils.intToHex(r)+utils.intToHex(a)+utils.intToHex(s)+utils.intToHex(c),n=SNprotoBufUtil.assemblyData("0004","06",i),o=SNprotoBufUtil.pushDataToMC(new Int8Array(utils.hexToBytes(n)).buffer);executeCmd(utils.ab2hex(o))}function executeCmd(e){e=e.toUpperCase(),console.log("发送指令"+e+":设备id="+deviceId+",serviceId="+serviceId);for(var t=new Int8Array(utils.hexToBytes(e)).buffer,r=0,a=t.byteLength;0<a;)!function(){var e=void 0;20<a?(e=t.slice(r,r+20),r+=20,a-=20):(e=t.slice(r,r+a),r+=a,a-=a),wx.writeBLECharacteristicValue({deviceId:deviceId,serviceId:serviceId,characteristicId:characteristicId,value:e,success:function(){console.log("write success==>"+utils.ab2hex(e))}})}()}module.exports={protoBufparseData:protoBufparseData,getHistoryData:getHistoryData,clearHistoryData:clearHistoryData};