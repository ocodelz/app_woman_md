"use strict";var protobuf=require("../weichatPb/protobuf.js"),utils=require("./util"),SNProtobufConig=require("./SNProtoBuf"),SNProtobufRoot=protobuf.Root.fromJSON(SNProtobufConig),CRC32=require("./crc32"),_require=require("./crc32"),buf=_require.buf,buf_8=_require.buf_8,SN_ReceiveProtobufLib={REQ_AUTH:10001,REQ_SENDDATA:10002,REQ_INIT:10003,RESQ_AUTH:20001,RESQ_SENDDATA:20002,RESQ_INIT:20003,ECI_PUSH_DATA:30001,VALID_COMMAND:65535},cmd_id=65535,START_SIGN="534E",ParseState={SYN_FE:"SYN_FE",SYN_VR:"SYN_VR",LEN:"LEN",PBODY:"PBODY",CHKSUM:"CHKSUM"},cmdparse=new Uint8Array(200),cmdcnt=0,psta=ParseState.SYN_FE;function sendCmdParser(e,t,r){if(t){var s=t.length+8,a=new Uint8Array(s);a[0]=254,a[1]=1,a[2]=s>>8&255,a[3]=255&s,a[4]=e>>8&255,a[5]=255&e,a[6]=r>>8&255,a[7]=255&r;for(var o=0;o<s-8;o++)a[8+o]=t[o];return a.buffer}}function AuthResponse(e){var t=SNProtobufRoot.lookupType("MmBp.SNProtobuf.AuthResponse").create(),r=SNProtobufRoot.lookupType("MmBp.SNProtobuf.BaseResponse").create();r.ErrCode=0,t.BaseResponse=r,t.AesSessionKey=new ArrayBuffer(0);var s=t.encode().finish();return sendCmdParser(SN_ReceiveProtobufLib.RESQ_AUTH,s,e)}function InitResponse(e,t){var r=CRC32.buf(new Uint8Array(e)),s=SNProtobufRoot.lookupType("MmBp.SNProtobuf.InitResponse").create(),a=SNProtobufRoot.lookupType("MmBp.SNProtobuf.BaseResponse").create();s.UserIdHigh=4660,s.UserIdLow=22136,s.ChalleangeAnswer=Number(r),a.ErrCode=0,s.BaseResponse=a;var o=s.encode().finish();return sendCmdParser(SN_ReceiveProtobufLib.RESQ_INIT,o,t)}function sendDataRequest(e){return SNProtobufRoot.lookupType("MmBp.SNProtobuf.SendDataRequest").decode(e).Data}function assemblyData(e,t,r){var s=START_SIGN,a=utils.intToHex(utils.hexToBytes(""+e+t+r).length),s=START_SIGN+a+e+t+r,o=a+e+t+r,n=0;utils.hexToBytes(o).forEach(function(e){n+=e});var u=utils.intToHex(n);return 2<u.length?s+=u.substring(u.length-2):s+=u,s.toUpperCase()}function pushDataToMC(e){var t="0A00120C"+utils.ab2hex(e)+"1800",r=new Uint8Array(utils.hexToBytes(t)),s=r.byteLength+8,a=new Uint8Array(s);return a[0]=254,a[1]=1,a[2]=(65535&s)>>8,a[3]=255&s,a[4]=117,a[5]=49,a[6]=0,a[7]=0,r.forEach(function(e,t){a[8+t]=e}),console.log("sendBuffer====>",utils.ab2hex(a.buffer).toUpperCase()),a.buffer}function setNewPsta(){return cmdparse=new Uint8Array(200),cmdcnt=0,psta=ParseState.SYN_FE,!0}function receiveParseByte(e){switch(psta){case ParseState.SYN_FE:if(83!=e)return"";psta=ParseState.SYN_VR;break;case ParseState.SYN_VR:if(78!=e)return psta=ParseState.SYN_FE,"";psta=ParseState.LEN,cmdparse.fill(0);break;case ParseState.LEN:if(e<4)return psta=ParseState.SYN_FE,"";cmdcnt=0,cmdparse[cmdcnt++]=e,psta=ParseState.PBODY;break;case ParseState.PBODY:cmdparse[cmdcnt++]=e,cmdcnt>=cmdparse[0]&&(psta=ParseState.CHKSUM);break;case ParseState.CHKSUM:return psta=ParseState.SYN_FE,e!=utils.checkSum(cmdparse,0,cmdcnt)||cmdcnt!=cmdparse[0]?"":cmdparse.buffer}return null}module.exports={AuthResponse:AuthResponse,InitResponse:InitResponse,pushDataToMC:pushDataToMC,sendDataRequest:sendDataRequest,assemblyData:assemblyData,receiveParseByte:receiveParseByte,setNewPsta:setNewPsta};