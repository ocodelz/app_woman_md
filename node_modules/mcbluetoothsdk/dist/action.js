"use strict";var _globalData_=null,_this_=null,utils=require("./utils/util.js"),http=require("./utils/http"),sxlAdapter=require("./adapters/sxlAdapter.js"),ug_11Adapter=require("./adapters/ug_11Adapter.js"),wlOneAdapter=require("./adapters/wlOneAdapter.js"),wlOneJYZYAdapter=require("./adapters/wlOneJYZYAdapter.js"),anwenAirAdapter=require("./adapters/anwenAirAdapter.js"),jw_airAdapter=require("./adapters/jw_airAdapter.js"),anNuoXinAdapter=require("./adapters/anNuoXinAdapter.js"),ea_12Adapter=require("./adapters/ea_12Adapter.js"),ea_18Adapter=require("./adapters/ea_18Adapter.js"),ka_11Adapter=require("./adapters/ka_11Adapter.js"),_dispatchState=null,DEVICE_TYPE_MAP={2:{deviceName:"掌越血脂血糖仪",deviceType:"XZXTY",bluetoothPrefix:"SLX",networkingMode:"NZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"},26:{deviceName:"UG-11系列血糖尿酸仪",deviceType:"XTNSY",bluetoothPrefix:"BDE_WEIXIN_TTM",networkingMode:"NZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"},10:{deviceName:"WL-1型蓝牙血糖仪",deviceType:"XTY",bluetoothPrefix:"Sinocare",networkingMode:"NZLY",service:"0000FFE0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFE1-0000-1000-8000-00805F9B34FB",writeid:"0000FFE2-0000-1000-8000-00805F9B34FB"},44:{deviceName:"WL-1型教育专员版血糖仪",deviceType:"XTY",bluetoothPrefix:"Sinocare",networkingMode:"NZLY",service:"",notifyid:"",writeid:""},25:{deviceName:"安稳+Air血糖仪",deviceType:"XTY",bluetoothPrefix:"BDE_WEIXIN_TTM",networkingMode:"NZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB"},13:{deviceName:"安诺心蓝牙血压计",deviceType:"XYJ",bluetoothPrefix:"ClinkBlood",networkingMode:"NZLY",service:"0000FC00-0000-1000-8000-00805F9B34FB",notifyid:"0000FCA1-0000-1000-8000-00805F9B34FB",writeid:"0000FCA0-0000-1000-8000-00805F9B34FB"},3:{deviceName:"EA-12血糖尿酸测试仪",deviceType:"XTNSY",bluetoothPrefix:"BDE_WEIXIN_TTM,SNPB,Jin",networkingMode:"WZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"},12:{deviceName:"EA-18血糖尿酸测试仪",deviceType:"XTNSY",bluetoothPrefix:"BDE_WEIXIN_TTM",networkingMode:"WZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"},1002:{deviceName:"金稳+Air血糖仪",deviceType:"XTY",bluetoothPrefix:"JW+AIR",networkingMode:"WZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"},4:{deviceName:"KA-11血糖血酮测试仪",deviceType:"XTXTCSY",bluetoothPrefix:"BDE_WEIXIN_TTM,SNPB",networkingMode:"WZLY",service:"0000FFB0-0000-1000-8000-00805F9B34FB",notifyid:"0000FFB2-0000-1000-8000-00805F9B34FB",writeid:"0000FFB2-0000-1000-8000-00805F9B34FB"}},_status={isLimit:!0,_multiDevice:[]};function initObjDefault(e,t,i){e&&t&&i&&(_this_=t,_globalData_=e,console.log(i),wxAuthentication(i),console.log("3434",_this_))}function checkSdkAuthorize(){return _status.isLimit&&_this_.showToast({title:"SDKToken无效，调用方法失败",icon:"none",duration:1e3}),!_status.isLimit}function getStatus(){return _status}function doInitMulti(e,t){var i;checkSdkAuthorize()&&(_status._multiDevice.map(function(e){e.deviceId}),i={deviceId:e,deviceType:void 0,connected:!1,service:"",deviceName:"",serviceId:"",readCharacteristicId:"",writeCharacteristicId:"",notifyCharacteristicId:"",isManualBreak:!1,isReconnectBreak:!1,canWrite:!1,uploadCbFun:void 0,failConnFbFun:void 0,discoveryTimeout:void 0,discoveryTimes:0},_status._multiDevice.push(i),t&&t())}function startMultiConnectDevice(e,t,i,a){var c=_status._multiDevice.findIndex(function(e){return e.deviceId===t});_status._multiDevice[c].deviceType=Number(e),_status._multiDevice[c].service=DEVICE_TYPE_MAP[e].service,_status._multiDevice[c].uploadCbFun=i,_status._multiDevice[c].deviceName=DEVICE_TYPE_MAP[e].deviceName,_status._multiDevice[c].failConnFbFun=a,console.log("开始连接设备 ：",_status._multiDevice[c]),console.log("currentMultiDeviceType: "+e+" 当前设备类型名称："+DEVICE_TYPE_MAP[e].deviceName),console.log("currentMultiDeviceId: "+t+" 当前设备deviceUUId："+t),createBLEConnection({deviceType:e,deviceUUId:t},!0)}function wxAuthentication(i){return _this_.showToast({title:"SDK授权...",icon:"loading",mask:!0,duration:1e3}),new Promise(function(t,e){http.post(!1,"clinic/appSDK/wxAuthentication",{wxSdkValidation:i._appId,wxSdkKey:i._wxSdkKey}).then(function(e){0===e.code?(_globalData_.sdkAccessToken=e.data.sdkAccessToken,_status.isLimit=!1,t(e.data)):(utils.showToastHint(e.msg),_status.isLimit=!0,t(!1))})})}function getBLEDeviceServices(i){var a=_status._multiDevice.findIndex(function(e){return e.deviceId===i});setTimeout(function(){_this_.getBLEDeviceServices({deviceId:i,success:function(e){console.log("多设备服务对应deviceUUId: "+i,e);for(var t=0;t<e.services.length;t++)if(console.log("设备deviceUUId"+i+"服务列表："+e.services[t].uuid+"\n"),_status._multiDevice[a].service){if(console.log(_status._multiDevice[a].service==e.services[t].uuid),_status._multiDevice[a].service==e.services[t].uuid)return _status._multiDevice[a].serviceId=_status._multiDevice[a].service,void deviceConnect(i,_status._multiDevice[a].service)}else if(e.services[t].isPrimary)return _status._multiDevice[a].serviceId=e.services[t].uuid,void deviceConnect(i,e.services[t].uuid)},fail:function(){console.log("error 失败")}})},2e3)}function deviceConnect(e,t){getBLEDeviceCharacteristics(e,t),onBLEConnectionStateChange()}function getBLEDeviceCharacteristics(c,e){var s=_status._multiDevice.findIndex(function(e){return e.deviceId===c});_this_.getBLEDeviceCharacteristics({deviceId:c,serviceId:e,success:function(e){for(var t,i=0;i<e.characteristics.length;i++){var a=e.characteristics[i];a.properties.read&&(console.log("多设备，设备Id"+c+"该特征值支持 read 操作:"+a.uuid),_status._multiDevice[s].readCharacteristicId=a.uuid),a.properties.write&&(console.log("多设备，设备Id"+c+"该特征值支持 write 操作:"+a.uuid),_status._multiDevice[s].writeCharacteristicId=a.uuid,_status._multiDevice[s].canWrite=!0),(a.properties.notify||a.properties.indicate)&&(console.log("多设备，设备Id"+c+"该特征值支持 notify 操作:"+a.uuid),_status._multiDevice[s].notifyCharacteristicId=a.uuid)}13===_status._multiDevice[s].deviceType?(t={deviceId:_status._multiDevice[s].deviceId,serviceId:_status._multiDevice[s].serviceId,writeCharacteristicId:_status._multiDevice[s].writeCharacteristicId,notifyCharacteristicId:_status._multiDevice[s].notifyCharacteristicId},setTimeout(function(){anNuoXinAdapter.anxSentOrder(t,notifyBLECharacteristicValueChange,_this_)},1e3)):notifyBLECharacteristicValueChange(_status._multiDevice[s].deviceId,_status._multiDevice[s].serviceId,_status._multiDevice[s].notifyCharacteristicId,!0)}})}function notifyBLECharacteristicValueChange(e,t,i){setTimeout(function(){_this_.notifyBLECharacteristicValueChange({state:!0,deviceId:e,serviceId:t,type:"notification",characteristicId:i,success:function(e){console.log(e.errMsg+": "+i+" serviceId: "+t),setTimeout(function(){onBLECharacteristicValueChange()},500)},fail:function(e){console.log(e.errCode+" "+e.errMsg),_this_.showToast({title:"notify启动失败",icon:"none",duration:1500})}})},1e3)}function onBLEConnectionStateChange(e,t){_this_.onBLEConnectionStateChange(function(t){console.log("deviceUUId "+t.deviceId+" state has changed, connected: "+t.connected);var e=_status._multiDevice.findIndex(function(e){return e.deviceId===t.deviceId});_status._multiDevice[e].connected=t.connected,_dispatchState&&_dispatchState(_status._multiDevice),t.connected||createBLEConnection({deviceUUId:t.deviceId},!0)})}function onBLECharacteristicValueChange(){_this_.onBLECharacteristicValueChange(function(t){var i,a="";switch(console.log("onBLECharacteristicValueChange: "+t),i=_status._multiDevice.findIndex(function(e){return e.deviceId===t.deviceId}),_status._multiDevice[i].deviceType){case 2:a=sxlAdapter.parseData(t);break;case 26:a=ug_11Adapter.parseData(t);break;case 10:a=wlOneAdapter.parseData(t);break;case 25:a=anwenAirAdapter.parseData(t);break;case 13:a=anNuoXinAdapter.parseData(t);break;case 3:a=ea_12Adapter.parseData(t);break;case 12:a=ea_18Adapter.parseData(t);break;case 1002:a=jw_airAdapter.parseData(t);break;case 44:console.log("wl-1"),wlOneJYZYAdapter.parseData(t).then(function(e){uploadDataFn(i,a=e)});break;case 51:a=pc_50Adapter.parseData(t);break;case 4:a=ka_11Adapter.parseData(t)}uploadDataFn(i,a)})}function uploadDataFn(e,t){if(t){-1<e?_status._multiDevice[e].uploadCbFun&&_status._multiDevice[e].uploadCbFun(t):_status._uploadCbFun&&_status._uploadCbFun(t),console.log("收到的信息："+JSON.stringify(t));try{saveData(t)}catch(e){}}}function saveData(e){var t=utils.receiveDataFormatter(e);t.deviceType=_status.deviceType,t.deviceMac=_status.currentDeviceId,http.post(!1,"clinic/appSDK/saveAPPSDKMedicalResult",t).then(function(e){e.code}).catch(function(e){})}function closeBlueTooth(t){_this_.closeBluetoothAdapter({success:function(e){_status._multiDevice=[],_status.isLimit=!0,t&&t(e)},fail:function(e){console.log(e),t&&t(e)}})}function createBLEConnection(t){var i=_status._multiDevice.findIndex(function(e){return e.deviceId===t.deviceUUId});_this_.createBLEConnection({deviceId:t.deviceUUId,success:function(){_status._multiDevice[i].connected=!0,_dispatchState&&_dispatchState(_status._multiDevice),getBLEDeviceServices(t.deviceUUId)},fail:function(e){console.log(t.deviceUUId+"err.errCode: "+e.errCode+" err.errMsg: "+e.errMsg),_status._multiDevice[i].connected=!1,_resetTimer_[t.deviceUUId]=setTimeout(function(){console.log("重连1",t),createBLEConnection(t)},3e3)}})}function dispatchConnectState(e){_dispatchState=e}module.exports={initObjDefault:initObjDefault,getStatus:getStatus,doInitMulti:doInitMulti,closeBlueTooth:closeBlueTooth,dispatchConnectState:dispatchConnectState,startMultiConnectDevice:startMultiConnectDevice};