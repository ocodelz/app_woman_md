"use strict";var tokenize,Root,Type,Field,MapField,OneOf,Enum,Service,Method,types,util;(module.exports=parse).filename=null,parse.defaults={keepCase:!1};var base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)+$/,fqTypeRefRe=/^(?:\.[a-zA-Z][a-zA-Z_0-9]*)+$/;function parse(e,t,r){t instanceof Root||(r=t,t=new Root),r=r||parse.defaults;var n,a,i,o,s,f=tokenize(e,r.alternateCommentMode||!1),c=f.next,u=f.push,p=f.peek,d=f.skip,l=f.cmnt,m=!0,h=!1,w=t,R=r.keepCase?function(e){return e}:util.camelCase;function v(e,t,r){var n=parse.filename;return r||(parse.filename=null),Error("illegal "+(t||"token")+" '"+e+"' ("+(n?n+", ":"")+"line "+f.line+")")}function y(){var e,t=[];do{if('"'!==(e=c())&&"'"!==e)throw v(e);t.push(c()),d(e),e=p()}while('"'===e||"'"===e);return t.join("")}function b(t){var r=c();switch(r){case"'":case'"':return u(r),y();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return function(e,t){var r=1;"-"===e.charAt(0)&&(r=-1,e=e.substring(1));switch(e){case"inf":case"INF":case"Inf":return r*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(e))return r*parseInt(e,10);if(base16Re.test(e))return r*parseInt(e,16);if(base8Re.test(e))return r*parseInt(e,8);if(numberRe.test(e))return r*parseFloat(e);throw v(e,"number",t)}(r,!0)}catch(e){if(t&&typeRefRe.test(r))return r;throw v(r,"value")}}function k(e,t){for(var r,n;!t||'"'!==(r=p())&&"'"!==r?e.push([n=g(c()),d("to",!0)?g(c()):n]):e.push(y()),d(",",!0););d(";")}function g(e,t){switch(e){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!t&&"-"===e.charAt(0))throw v(e,"id");if(base10NegRe.test(e))return parseInt(e,10);if(base16NegRe.test(e))return parseInt(e,16);if(base8NegRe.test(e))return parseInt(e,8);throw v(e,"id")}function q(e,t){switch(t){case"option":return x(e,t),d(";"),1;case"message":return function(e,t){if(!nameRe.test(t=c()))throw v(t,"type name");var r=new Type(t);F(r,function(e){if(!q(r,e))switch(e){case"map":!function(e){d("<");var t=c();if(void 0===types.mapKey[t])throw v(t,"type");d(",");var r=c();if(!typeRefRe.test(r))throw v(r,"type");d(">");var n=c();if(!nameRe.test(n))throw v(n,"name");d("=");var a=new MapField(R(n),g(c()),t,r);F(a,function(e){if("option"!==e)throw v(e);x(a,e),d(";")},function(){z(a)}),e.add(a)}(r);break;case"required":case"optional":case"repeated":N(r,e);break;case"oneof":!function(e,t){if(!nameRe.test(t=c()))throw v(t,"name");var r=new OneOf(R(t));F(r,function(e){"option"===e?(x(r,e),d(";")):(u(e),N(r,"optional"))}),e.add(r)}(r,e);break;case"extensions":k(r.extensions||(r.extensions=[]));break;case"reserved":k(r.reserved||(r.reserved=[]),!0);break;default:if(!h||!typeRefRe.test(e))throw v(e);u(e),N(r,"optional")}}),e.add(r)}(e,t),1;case"enum":return function(e,t){if(!nameRe.test(t=c()))throw v(t,"name");var r=new Enum(t);F(r,function(e){switch(e){case"option":x(r,e),d(";");break;case"reserved":k(r.reserved||(r.reserved=[]),!0);break;default:!function(e,t){if(!nameRe.test(t))throw v(t,"name");d("=");var r=g(c(),!0),n={};F(n,function(e){if("option"!==e)throw v(e);x(n,e),d(";")},function(){z(n)}),e.add(t,r,n.comment)}(r,e)}}),e.add(r)}(e,t),1;case"service":return function(e,t){if(!nameRe.test(t=c()))throw v(t,"service name");var r=new Service(t);F(r,function(e){if(!q(r,e)){if("rpc"!==e)throw v(e);!function(e,t){var r=t;if(!nameRe.test(t=c()))throw v(t,"name");var n,a,i,o,s=t;d("("),d("stream",!0)&&(a=!0);if(!typeRefRe.test(t=c()))throw v(t);n=t,d(")"),d("returns"),d("("),d("stream",!0)&&(o=!0);if(!typeRefRe.test(t=c()))throw v(t);i=t,d(")");var f=new Method(s,r,n,i,a,o);F(f,function(e){if("option"!==e)throw v(e);x(f,e),d(";")}),e.add(f)}(r,e)}}),e.add(r)}(e,t),1;case"extend":return function(t,e){if(!typeRefRe.test(e=c()))throw v(e,"reference");var r=e;F(null,function(e){switch(e){case"required":case"repeated":case"optional":N(t,e,r);break;default:if(!h||!typeRefRe.test(e))throw v(e);u(e),N(t,"optional",r)}})}(e,t),1}}function F(e,t,r){var n,a=f.line;if(e&&(e.comment=l(),e.filename=parse.filename),d("{",!0)){for(;"}"!==(n=c());)t(n);d(";",!0)}else r&&r(),d(";"),e&&"string"!=typeof e.comment&&(e.comment=l(a))}function N(e,t,r){var n=c();if("group"!==n){if(!typeRefRe.test(n))throw v(n,"type");var a=c();if(!nameRe.test(a))throw v(a,"name");a=R(a),d("=");var i=new Field(a,g(c()),n,t,r);F(i,function(e){if("option"!==e)throw v(e);x(i,e),d(";")},function(){z(i)}),e.add(i),h||!i.repeated||void 0===types.packed[n]&&void 0!==types.basic[n]||i.setOption("packed",!1,!0)}else!function(e,t){var r=c();if(!nameRe.test(r))throw v(r,"name");var n=util.lcFirst(r);r===n&&(r=util.ucFirst(r));d("=");var a=g(c()),i=new Type(r);i.group=!0;var o=new Field(n,a,r,t);o.filename=parse.filename,F(i,function(e){switch(e){case"option":x(i,e),d(";");break;case"required":case"optional":case"repeated":N(i,e);break;default:throw v(e)}}),e.add(i).add(o)}(e,t)}function x(e,t){var r=d("(",!0);if(!typeRefRe.test(t=c()))throw v(t,"name");var n=t;r&&(d(")"),n="("+n+")",t=p(),fqTypeRefRe.test(t)&&(n+=t,c())),d("="),function e(t,r){if(d("{",!0))do{if(!nameRe.test(s=c()))throw v(s,"name");"{"===p()?e(t,r+"."+s):(d(":"),"{"===p()?e(t,r+"."+s):A(t,r+"."+s,b(!0)))}while(!d("}",!0));else A(t,r,b(!0))}(e,n)}function A(e,t,r){e.setOption&&e.setOption(t,r)}function z(e){if(d("[",!0)){for(;x(e,"option"),d(",",!0););d("]")}return e}for(;null!==(s=c());)switch(s){case"package":if(!m)throw v(s);!function(){if(void 0!==n)throw v("package");if(n=c(),!typeRefRe.test(n))throw v(n,"name");w=w.define(n),d(";")}();break;case"import":if(!m)throw v(s);!function(){var e,t=p();switch(t){case"weak":e=i=i||[],c();break;case"public":c();default:e=a=a||[]}t=y(),d(";"),e.push(t)}();break;case"syntax":if(!m)throw v(s);!function(){if(d("="),o=y(),!(h="proto3"===o)&&"proto2"!==o)throw v(o,"syntax");d(";")}();break;case"option":if(!m)throw v(s);x(w,s),d(";");break;default:if(q(w,s)){m=!1;continue}throw v(s)}return parse.filename=null,{package:n,imports:a,weakImports:i,syntax:o,root:t}}parse._configure=function(){tokenize=require("./tokenize"),Root=require("./root"),Type=require("./type"),Field=require("./field"),MapField=require("./mapField"),OneOf=require("./oneof"),Enum=require("./enum"),Service=require("./service"),Method=require("./method"),types=require("./types"),util=require("./util")};