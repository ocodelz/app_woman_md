"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=Root;var Namespace=require("./namespace");((Root.prototype=Object.create(Namespace.prototype)).constructor=Root).className="Root";var Type,parse,common,Field=require("./field"),Enum=require("./enum"),OneOf=require("./oneof"),util=require("./util");function Root(e){Namespace.call(this,"",e),this.deferred=[],this.files=[],this.names=[]}function SYNC(){}function parseFromPbString(e,i,n){"function"==typeof i&&(n=i,i=void 0);var s=this;if(!n)return util.asPromise(parseFromPbString,s,e,i);var t=null;if("string"==typeof e)t=JSON.parse(e);else{if("object"!==(void 0===e?"undefined":_typeof(e)))return void console.log("pb格式转化失败");t=e}function a(e,t){var o;n&&(o=n,n=null,o(e,t))}function o(e,t){try{if(util.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),util.isString(t)){parse.filename=e;var o,n=parse(t,s,i),r=0;if(n.imports)for(;r<n.imports.length;++r)l(o=n.imports[r]);if(n.weakImports){for(r=0;r<n.weakImports.length;++r)o=n.weakImports[r];l(o)}}else s.setOptions(t.options).addJSON(t.nested)}catch(e){a(e)}a(null,s)}function l(e){-1<s.names.indexOf(e)||(s.names.push(e),e in common&&o(e,common[e]))}o(t.name,t.pbJsonStr)}Root.fromJSON=function(e,t){return e="string"==typeof e?JSON.parse(e):e,t=t||new Root,e.options&&t.setOptions(e.options),t.addJSON(e.nested)},Root.prototype.resolvePath=util.path.resolve,Root.prototype.parseFromPbString=parseFromPbString,Root.prototype.load=function e(t,i,s){"function"==typeof i&&(s=i,i=void 0);var a=this;if(!s)return util.asPromise(e,a,t,i);var l=s===SYNC;function f(e,t){if(s){var o=s;if(s=null,l)throw e;o(e,t)}}function p(e,t){try{if(util.isString(t)&&"{"===t.charAt(0)&&(t=JSON.parse(t)),util.isString(t)){parse.filename=e;var o,n=parse(t,a,i),r=0;if(n.imports)for(;r<n.imports.length;++r)(o=a.resolvePath(e,n.imports[r]))&&u(o);if(n.weakImports)for(r=0;r<n.weakImports.length;++r)(o=a.resolvePath(e,n.weakImports[r]))&&u(o,!0)}else a.setOptions(t.options).addJSON(t.nested)}catch(e){f(e)}l||d||f(null,a)}function u(o,n){var e,t,r=o.lastIndexOf("google/protobuf/");if(-1<r&&((e=o.substring(r))in common&&(o=e)),!(-1<a.files.indexOf(o)))if(a.files.push(o),o in common)l?p(o,common[o]):(++d,setTimeout(function(){--d,p(o,common[o])}));else if(l){try{t=util.fs.readFileSync(o).toString("utf8")}catch(e){return void(n||f(e))}p(o,t)}else++d,util.fetch(o,function(e,t){--d,s&&(e?n?d||f(null,a):f(e):p(o,t))})}var d=0;util.isString(t)&&(t=[t]);for(var o,n=0;n<t.length;++n)(o=a.resolvePath("",t[n]))&&u(o);if(l)return a;d||f(null,a)},Root.prototype.loadSync=function(e,t){if(!util.isNode)throw Error("not supported");return this.load(e,t,SYNC)},Root.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(e){return"'extend "+e.extend+"' in "+e.parent.fullName}).join(", "));return Namespace.prototype.resolveAll.call(this)};var exposeRe=/^[A-Z]/;function tryHandleExtension(e,t){var o=t.parent.lookup(t.extend);if(o){var n=new Field(t.fullName,t.id,t.type,t.rule,void 0,t.options);return(n.declaringField=t).extensionField=n,o.add(n),!0}return!1}Root.prototype._handleAdd=function(e){if(e instanceof Field)void 0===e.extend||e.extensionField||tryHandleExtension(this,e)||this.deferred.push(e);else if(e instanceof Enum)exposeRe.test(e.name)&&(e.parent[e.name]=e.values);else if(!(e instanceof OneOf)){if(e instanceof Type)for(var t=0;t<this.deferred.length;)tryHandleExtension(this,this.deferred[t])?this.deferred.splice(t,1):++t;for(var o=0;o<e.nestedArray.length;++o)this._handleAdd(e._nestedArray[o]);exposeRe.test(e.name)&&(e.parent[e.name]=e)}},Root.prototype._handleRemove=function(e){var t;if(e instanceof Field)void 0!==e.extend&&(e.extensionField?(e.extensionField.parent.remove(e.extensionField),e.extensionField=null):-1<(t=this.deferred.indexOf(e))&&this.deferred.splice(t,1));else if(e instanceof Enum)exposeRe.test(e.name)&&delete e.parent[e.name];else if(e instanceof Namespace){for(var o=0;o<e.nestedArray.length;++o)this._handleRemove(e._nestedArray[o]);exposeRe.test(e.name)&&delete e.parent[e.name]}},Root._configure=function(){Type=require("./type"),parse=require("./parse"),common=require("./common"),Field=require("./field"),Enum=require("./enum"),OneOf=require("./oneof"),util=require("./util")};